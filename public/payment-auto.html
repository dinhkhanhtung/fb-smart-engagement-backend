<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB Smart Engagement Pro - Thanh to√°n t·ª± ƒë·ªông</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            border: none;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background: linear-gradient(45deg, #667eea, #764ba2);
            border: none;
            border-radius: 10px;
            padding: 12px 30px;
        }
        .bank-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
        }
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            cursor: pointer;
        }
        .payment-code {
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 2px;
        }
        .status-checking {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .status-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .status-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Admin Login Button -->
        <div class="text-end mb-3">
            <a href="/admin" class="btn btn-outline-light btn-sm">
                <i class="fas fa-cog me-2"></i>Admin Login
            </a>
        </div>
        
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-body p-5">
                        <h1 class="text-center mb-4">üöÄ FB Smart Engagement Pro</h1>
                        <h3 class="text-center mb-4">N√¢ng c·∫•p l√™n PRO</h3>

                        <!-- Plan Selection -->
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="card plan-card" onclick="selectPlan('monthly', 99000)">
                                    <div class="card-body text-center">
                                        <h5>üìÖ Th√°ng</h5>
                                        <h3 class="text-primary">99,000‚Ç´</h3>
                                        <p>Thanh to√°n h√†ng th√°ng</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card plan-card" onclick="selectPlan('yearly', 990000)">
                                    <div class="card-body text-center">
                                        <h5>üìÜ NƒÉm</h5>
                                        <h3 class="text-primary">990,000‚Ç´</h3>
                                        <p>Ti·∫øt ki·ªám 2 th√°ng</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card plan-card" onclick="selectPlan('lifetime', 1990000)">
                                    <div class="card-body text-center">
                                        <h5>‚ôæÔ∏è Tr·ªçn ƒë·ªùi</h5>
                                        <h3 class="text-primary">1,990,000‚Ç´</h3>
                                        <p>S·ª≠ d·ª•ng m√£i m√£i</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Form -->
                        <div id="payment-form" style="display: none;">
                            <h4>Th√¥ng tin thanh to√°n</h4>
                            <div class="mb-3">
                                <label class="form-label">H·ªç t√™n</label>
                                <input type="text" class="form-control" id="name" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i</label>
                                <input type="tel" class="form-control" id="phone" required>
                            </div>
                            
                            <button class="btn btn-primary w-100" onclick="generatePaymentCode()">
                                <i class="fas fa-barcode me-2"></i>T·∫°o m√£ thanh to√°n
                            </button>
                        </div>

                        <!-- Bank Transfer Info -->
                        <div id="bank-info" style="display: none;">
                            <h4>Th√¥ng tin chuy·ªÉn kho·∫£n</h4>
                            
                            <!-- Payment Code -->
                            <div class="payment-code mb-4">
                                <i class="fas fa-barcode me-2"></i>
                                <span id="payment-code">FB20250101001</span>
                                <button class="btn btn-light btn-sm ms-3" onclick="copyToClipboard('payment-code')">
                                    <i class="fas fa-copy me-1"></i>Copy
                                </button>
                            </div>

                            <div class="bank-info">
                                <div class="row">
                                    <div class="col-md-6">
                                        <strong>S·ªë t√†i kho·∫£n:</strong>
                                        <span id="account-number">0982581222</span>
                                        <button class="copy-btn ms-2" onclick="copyToClipboard('account-number')">Copy</button>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>T√™n ch·ªß t√†i kho·∫£n:</strong>
                                        <span id="account-name">ƒêinh Kh√°nh T√πng</span>
                                        <button class="copy-btn ms-2" onclick="copyToClipboard('account-name')">Copy</button>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong>Ng√¢n h√†ng:</strong>
                                        <span id="bank-name">BIDV</span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>Chi nh√°nh:</strong>
                                        <span id="bank-branch">BIDV</span>
                                    </div>
                                </div>
                                <div class="row mt-2">
                                    <div class="col-md-6">
                                        <strong>S·ªë ti·ªÅn:</strong>
                                        <span id="amount" class="text-danger fw-bold"></span>
                                    </div>
                                    <div class="col-md-6">
                                        <strong>N·ªôi dung chuy·ªÉn kho·∫£n:</strong>
                                        <span id="content" class="text-primary fw-bold"></span>
                                        <button class="copy-btn ms-2" onclick="copyToClipboard('content')">Copy</button>
                                    </div>
                                </div>
                            </div>

                            <div class="alert alert-info">
                                <strong>H∆∞·ªõng d·∫´n:</strong>
                                <ol>
                                    <li><strong>Chuy·ªÉn kho·∫£n</strong> ƒë√∫ng s·ªë ti·ªÅn v√† n·ªôi dung (c√≥ m√£ thanh to√°n)</li>
                                    <li><strong>Ch·ªù 5-10 ph√∫t</strong> ƒë·ªÉ h·ªá th·ªëng t·ª± ƒë·ªông x√°c nh·∫≠n</li>
                                    <li><strong>Ki·ªÉm tra email</strong> ƒë·ªÉ nh·∫≠n license key PRO</li>
                                    <li>N·∫øu kh√¥ng t·ª± ƒë·ªông, g·ª≠i ·∫£nh bi√™n lai qua Zalo: <strong>0982581222</strong></li>
                                </ol>
                            </div>

                            <!-- Auto Check Status -->
                            <div class="text-center">
                                <div id="status-check" class="alert status-checking">
                                    <i class="fas fa-clock me-2"></i>
                                    <span id="status-text">ƒêang ki·ªÉm tra thanh to√°n...</span>
                                    <div class="mt-2">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Success Message -->
                        <div id="success-message" style="display: none;">
                            <div class="alert alert-success text-center">
                                <h4>‚úÖ Thanh to√°n th√†nh c√¥ng!</h4>
                                <p>License key PRO ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n.</p>
                                <p>Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ (c√≥ th·ªÉ trong th∆∞ m·ª•c Spam).</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="fas fa-redo me-2"></i>T·∫°o giao d·ªãch m·ªõi
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let selectedPlan = null;
        let selectedAmount = 0;
        let paymentId = null;
        let checkInterval = null;

        function selectPlan(plan, amount) {
            selectedPlan = plan;
            selectedAmount = amount;
            
            // Remove active class from all cards
            document.querySelectorAll('.plan-card').forEach(card => {
                card.classList.remove('border-primary');
            });
            
            // Add active class to selected card
            event.currentTarget.classList.add('border-primary');
            
            // Show payment form
            document.getElementById('payment-form').style.display = 'block';
        }

        async function generatePaymentCode() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const phone = document.getElementById('phone').value;
            
            if (!name || !email || !phone) {
                alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
                return;
            }

            try {
                // Generate payment code
                paymentId = 'FB' + Date.now();
                
                // Update display
                document.getElementById('payment-code').textContent = paymentId;
                document.getElementById('amount').textContent = selectedAmount.toLocaleString() + '‚Ç´';
                document.getElementById('content').textContent = `FBENGAGE ${paymentId}`;
                
                // Show bank info
                document.getElementById('payment-form').style.display = 'none';
                document.getElementById('bank-info').style.display = 'block';
                
                // Start auto checking
                startAutoCheck();
                
                // Create payment record
                await fetch('/api/payment/bank-transfer', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: 'user_' + Date.now(),
                        plan: selectedPlan,
                        amount: selectedAmount,
                        paymentCode: paymentId,
                        userInfo: {
                            name: name,
                            email: email,
                            phone: phone
                        }
                    })
                });

            } catch (error) {
                alert('L·ªói t·∫°o m√£ thanh to√°n: ' + error.message);
            }
        }

        function startAutoCheck() {
            let attempts = 0;
            const maxAttempts = 20; // 20 attempts = 10 minutes
            
            checkInterval = setInterval(async () => {
                attempts++;
                
                try {
                    const response = await fetch(`/api/payment/check/${paymentId}`);
                    const result = await response.json();
                    
                    if (result.status === 'paid') {
                        // Payment confirmed
                        clearInterval(checkInterval);
                        document.getElementById('status-check').className = 'alert status-success';
                        document.getElementById('status-text').innerHTML = '<i class="fas fa-check me-2"></i>Thanh to√°n ƒë√£ ƒë∆∞·ª£c x√°c nh·∫≠n!';
                        
                        // Show success message
                        setTimeout(() => {
                            document.getElementById('bank-info').style.display = 'none';
                            document.getElementById('success-message').style.display = 'block';
                        }, 2000);
                        
                    } else if (attempts >= maxAttempts) {
                        // Timeout
                        clearInterval(checkInterval);
                        document.getElementById('status-check').className = 'alert status-error';
                        document.getElementById('status-text').innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>H·∫øt th·ªùi gian ch·ªù. Vui l√≤ng li√™n h·ªá Zalo: 0982581222';
                    } else {
                        // Still checking
                        document.getElementById('status-text').textContent = `ƒêang ki·ªÉm tra thanh to√°n... (${attempts}/${maxAttempts})`;
                    }
                    
                } catch (error) {
                    console.error('Check payment error:', error);
                }
            }, 30000); // Check every 30 seconds
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            navigator.clipboard.writeText(text).then(() => {
                alert('ƒê√£ copy: ' + text);
            });
        }
    </script>
</body>
</html>
